<script>
  const poem = document.getElementById("poem");
  const toggle = document.getElementById("toggle");
  const body = document.body;

  const echoWords = {
    difficult: 'down',
    imagine: 'up',
    possibilities: 'down',
    hard: 'up',
    fantasy: 'down',
    dilemma: 'down',
    challenge: 'up',
    puzzle: 'down',
    or: 'down',
    blessing: 'up',
    questions: 'down',
    sacred: 'up',
    start: 'down',
    with: 'up',
    hold: 'down',
    allow: 'down',
    surrender: 'down',
    know: 'up',
    care: 'down',
    wise: 'down',
    investment: 'up',
    seen: 'right',
    invited: 'down',
  };

  // Save the original poem safely
  const originalPoem = poem.textContent;

  function applyEchoHighlighting() {
    const directionCounters = {};
    let result = originalPoem;

    for (const [word, direction] of Object.entries(echoWords)) {
      directionCounters[word] = 0;

      // Match words even with punctuation following
      const regex = new RegExp(`\\b(${word})([\\.,\\?â€¦]*)`, "gi");

      result = result.replace(regex, (match, core, punctuation) => {
        const level = directionCounters[word]++;
        const className = `echo-${direction}-${Math.min(level, 3)}`;
        return `<span class="${className}">${core}</span>${punctuation}`;
      });
    }

    poem.innerHTML = result;
  }

  function updateThemeClasses() {
    const isDark = body.classList.contains("dark");
    const newTheme = isDark ? "light" : "dark";

    body.classList.remove("dark", "light");
    poem.classList.remove("dark", "light");
    body.classList.add(newTheme);
    poem.classList.add(newTheme);

    toggle.textContent = isDark ? "Switch to Dark Mode" : "Switch to Light Mode";

    // Rerun echo highlight from original poem
    applyEchoHighlighting();
  }

  // Initial render
  applyEchoHighlighting();

  toggle.addEventListener("click", updateThemeClasses);
</script>
