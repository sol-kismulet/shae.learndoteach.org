<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shae Layout (Echo Model + Mode Toggle)</title>
  <style>
    :root {
      --foreground: #111111;
      --background: #ffffff;
    }

    .dark {
      --foreground: #ffffff;
      --background: #000000;
    }

    body {
      margin: 0;
      padding: 2rem;
      font-family: Georgia, serif;
      background-color: var(--background);
      color: var(--foreground);
      transition: background-color 0.4s, color 0.4s;
    }

    pre {
      white-space: pre-wrap;
      font-size: 1rem;
      line-height: 1.6;
      transition: color 0.4s;
      color: var(--foreground);
    }

    .echo-up-0 { opacity: 0.15; color: var(--foreground); }
    .echo-up-1 { opacity: 0.4; color: var(--foreground); }
    .echo-up-2 { opacity: 0.7; color: var(--foreground); }
    .echo-up-3 { opacity: 1; color: var(--foreground); }

    .echo-down-0 { opacity: 1; color: var(--foreground); }
    .echo-down-1 { opacity: 0.7; color: var(--foreground); }
    .echo-down-2 { opacity: 0.4; color: var(--foreground); }
    .echo-down-3 { opacity: 0.15; color: var(--foreground); }

    .echo-right-0 { opacity: 1; color: var(--foreground); }
    .echo-right-1 { opacity: 0.7; color: var(--foreground); }
    .echo-right-2 { opacity: 0.4; color: var(--foreground); }
    .echo-right-3 { opacity: 0.15; color: var(--foreground); }

    .echo-up-0::selection, .echo-down-3::selection, .echo-right-3::selection {
      background: var(--foreground);
      color: var(--background);
    }

    button {
      margin-top: 2rem;
      font-family: Georgia, serif;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      background: transparent;
      border: 1px solid currentColor;
      color: inherit;
      cursor: pointer;
      transition: background 0.3s, color 0.3s;
    }

    .button-container {
      text-align: center;
    }
  </style>
</head>
<body class="dark">
<pre id="poem">
Shae,

                                           imagine
                    been difficult       imagine       possibilities
   It hasn’t           difficult    to imagine the   possibilities 
                     difficult                     possibilities

                 hard
               hard to imagine                     a fantasy?
       is it hard    imagine   if it were all just     fantasy
                   imagine.                              fantasy
                                     challenge
                                   challenge
                                 challenge?                or…
          such a dilemma…                 a puzzle?        or…
               dilemma                    puzzle           or…
             dilemma                    puzzle             or…
                                                           or…
                a quiet quandary…                          or…

                or…
                                                           
                or…
              blessing                           sacred
            blessing      questions is        sacred start
          blessing these    questions   the sacred start
                              questions          start

                  with
                with         and allow…              surrender
        to be with… to hold…       allow     in full   surrender 
                         hold        allow               surrender
                           hold
          know                                investment
        know              is a wise         investment
      know that this care        wise     investment
                       care        wise
                         care


you are seen seen seen


thank you


you are invited
        invited
        invited
        invited
</pre>

<div class="button-container">
  <button id="toggle">Switch to Light Mode</button>
</div>

<script>
  const poem = document.getElementById("poem");
  const toggle = document.getElementById("toggle");
  const body = document.body;

  const echoWords = {
    difficult: 'down',
    imagine: 'up',
    possibilities: 'down',
    hard: 'up',
    fantasy: 'down',
    dilemma: 'down',
    challenge: 'up',
    puzzle: 'down',
    or: 'down',
    blessing: 'up',
    questions: 'down',
    sacred: 'up',
    start: 'down',
    with: 'up',
    hold: 'down',
    allow: 'down',
    surrender: 'down',
    know: 'up',
    care: 'down',
    wise: 'down',
    investment: 'up',
    seen: 'right',
    invited: 'down'
  };

  const originalPoem = poem.innerText;

  function escapeHtml(text) {
    const span = document.createElement("span");
    span.textContent = text;
    return span.innerHTML;
  }

  function applyEchoHighlighting() {
    const matchMap = {};
    const matches = [];
    const regex = new RegExp(`\\b(${Object.keys(echoWords).join('|')})([\\.,\\?…]*)`, 'gi');
    let match;
    while ((match = regex.exec(originalPoem)) !== null) {
      matches.push({
        word: match[1],
        punctuation: match[2] || '',
        index: match.index
      });
    }

    const sortedMatches = matches.sort((a, b) => a.index - b.index);
    const echoGroups = {};

    for (const m of sortedMatches) {
      const direction = echoWords[m.word.toLowerCase()];
      if (!echoGroups[m.word]) echoGroups[m.word] = [];
      echoGroups[m.word].push(m);
    }

    let result = escapeHtml(originalPoem);
    for (const [word, direction] of Object.entries(echoWords)) {
      const group = echoGroups[word] || [];
      const length = group.length;

      for (let i = 0; i < length; i++) {
        const level = direction === 'up'
          ? Math.min(length - 1 - i, 3)
          : Math.min(i, 3);

        const matchText = `${group[i].word}${group[i].punctuation}`;
        const span = `<span class="echo-${direction}-${level}">${group[i].word}</span>${group[i].punctuation}`;
        result = result.replace(matchText, span);
      }
    }

    poem.innerHTML = result;
  }

  function updateThemeClasses() {
    const isDark = body.classList.contains("dark");
    const newTheme = isDark ? "light" : "dark";

    body.classList.remove("dark", "light");
    poem.classList.remove("dark", "light");
    body.classList.add(newTheme);
    poem.classList.add(newTheme);

    toggle.textContent = isDark ? "Switch to Dark Mode" : "Switch to Light Mode";

    applyEchoHighlighting();
  }

  applyEchoHighlighting();
  toggle.addEventListener("click", updateThemeClasses);
</script>
</body>
</html>
