<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shae Echo Layout (Unified)</title>
  <style>
    :root {
      --foreground: #111111;
      --background: #ffffff;
    }
    .dark {
      --foreground: #ffffff;
      --background: #000000;
    }
    body {
      margin: 0;
      padding: 2rem;
      font-family: Georgia, serif;
      background-color: var(--background);
      color: var(--foreground);
      transition: background-color 0.4s, color 0.4s;
    }
    #poem {
      white-space: pre-wrap;
      font-size: 1rem;
      line-height: 1.6;
      transition: color 0.4s;
    }
    .echo-0 { opacity: 1; color: var(--foreground); }
    .echo-1 { opacity: 0.7; color: var(--foreground); }
    .echo-2 { opacity: 0.45; color: var(--foreground); }
    .echo-3 { opacity: 0.3; color: var(--foreground); }
    button {
      margin-top: 2rem;
      font-family: Georgia, serif;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      background: transparent;
      border: 1px solid currentColor;
      color: inherit;
      cursor: pointer;
      transition: background 0.3s, color 0.3s;
    }
    .button-container {
      text-align: center;
    }
  </style>
</head>
<body class="dark">
  <div id="poem">
Shae,

                                           imagine
                    been difficult       imagine       possibilities
   It hasn’t           difficult    to imagine the   possibilities 
                     difficult                     possibilities

                 hard
               hard to imagine                     a fantasy?
       is it hard    imagine   if it were all just     fantasy
                   imagine.                              fantasy
                                     challenge
                                   challenge
                                 challenge?                or…
          such a dilemma…                 a puzzle?        or…
               dilemma                    puzzle           or…
             dilemma                    puzzle             or…
                                                           or…
                a quiet quandary…                          or…

                or…
                                                           
                or…
              blessing                           sacred
            blessing      questions is        sacred start
          blessing these    questions   the sacred start
                              questions          start

                  with
                with         and allow…              surrender
        to be with… to hold…       allow     in full   surrender 
                         hold        allow               surrender
                           hold
          know                                investment
        know              is a wise         investment
      know that this care        wise     investment
                       care        wise
                         care


you are seen seen seen


thank you


you are invited
        invited
        invited
        invited
  </div>

  <div class="button-container">
    <button id="toggle">Switch to Light Mode</button>
  </div>

  <script>
    const poem = document.getElementById("poem");
    const toggle = document.getElementById("toggle");
    const body = document.body;

    const echoWords = {
      difficult: 'down',
      imagine: 'up',
      possibilities: 'down',
      hard: 'up',
      fantasy: 'down',
      dilemma: 'down',
      challenge: 'up',
      puzzle: 'down',
      or: 'down',
      blessing: 'up',
      questions: 'down',
      sacred: 'up',
      start: 'down',
      with: 'up',
      hold: 'down',
      allow: 'down',
      surrender: 'down',
      know: 'up',
      care: 'down',
      wise: 'down',
      investment: 'up',
      seen: 'right',
      invited: 'down'
    };

    const originalPoem = poem.innerText;

    function tokenize(text) {
      return text.split(/(\s+|\b)/); // keep whitespace and word boundaries
    }

    function highlightEchoes() {
      const tokens = tokenize(originalPoem);
      const echoInstances = {};

      // Count occurrences and track indices
      tokens.forEach((t, i) => {
        const word = t.toLowerCase().replace(/[.,!?…]/g, '');
        if (echoWords[word]) {
          if (!echoInstances[word]) echoInstances[word] = [];
          echoInstances[word].push({ index: i, original: t });
        }
      });

      // Replace tokens with spans based on direction and position
      for (const [word, instances] of Object.entries(echoInstances)) {
        const direction = echoWords[word];
        const sorted = direction === 'up' ? [...instances].reverse() : instances;

        sorted.forEach((instance, i) => {
          const level = Math.min(i, 3);
          tokens[instance.index] = `<span class="echo-${level}">${instance.original}</span>`;
        });
      }

      poem.innerHTML = tokens.join('');
    }

    function updateTheme() {
      const isDark = body.classList.contains("dark");
      const newTheme = isDark ? "light" : "dark";
      body.classList.remove("dark", "light");
      body.classList.add(newTheme);
      toggle.textContent = isDark ? "Switch to Dark Mode" : "Switch to Light Mode";
    }

    toggle.addEventListener("click", () => {
      updateTheme();
      highlightEchoes();
    });

    highlightEchoes();
  </script>
</body>
</html>
